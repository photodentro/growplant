<!doctype html> 
<!-- Copyright (C) 2018 Alkis Georgopoulos <alkisg@gmail.com>. License: GPLv3. -->
<html lang="el"> 
<head> 
  <meta charset="UTF-8" />
  <!-- Using this metatag users can't scale the page using pinchIn/out gestures on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Ανάπτυξη φυτού</title> 
  <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
  <style type="text/css">
    /* Remove margins and HTML scrollbars */
    body, html  {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: black;
    }
    #mainCanvas {
    padding: 0;
    margin: auto;
    display: block;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    }
  </style>
</head>
<body onload = "init();">
  <canvas id="mainCanvas" width="320" height="180">
    Your browser doesn't support HTML5!
  </canvas>
<script>
  var stage;
  var resourceNames = ['background.svg', 'bar_home.svg', 'bar_help.svg', 'bar_about.svg', 'bar_previous.svg', 'bar_next.svg', 
  'openwindow.svg', 'closewindow.svg', 'potistiri.svg', 'plant.png', 'popup.svg','playactive.svg','playinactive.svg', 'water.png'];
  var resourcesLoaded = 0;
  var resources = [];
  var ratio = 16/9;
  var winratio;
  var boxl;
  var boxr;
  var menubar = [];
  var level = 0; 
  var bg;
  var statusText;
  var theWindow;
  var isWindowOpen;
  var potistiri;
  var plant;
  var waterBarText;
  var popupCont;
  var popupBkg;
  var popupTxt;
  var pu;
  var playButton;
  var waterbarCont;
  var waterbar = new createjs.Shape();
  var waterLevel = 1;
  var isWatering;
  var water; //the image of the water drops
  var time = 0;
  var frame = 0;
  var timeWithoutWater = 0;//plant is dying if left without water for much time
  var waterThreshold = 20;
  var timeWithSun = 0; //plant will die if left without sun for some sunPercentage
  var sunThreshold = 0.3;
  var isPlaying = false;

  function popup(){
    this.setTxt = popupSetTxt;
    this.show = popupShow;
    this.hide = popupHide;
    this.resize = popupResize;
    //this.resize = popupResize;
  }
  function popupHide(){
    popupBkg.visible = false;
    popupTxt.visible = false;
    stage.update();
  }
  function popupSetTxt(txt){
    this.txt = txt;
  }

  function popupResize(){
    popupTxt.font = parseInt(stage.canvas.height/30) + "px Arial";
    popupTxt.x = 34/1280*stage.canvas.width;
    popupTxt.y = 86/720*stage.canvas.height;
    popupCont.x = 280/1280*stage.canvas.width;
    popupCont.y = 210/720*stage.canvas.height;
    popupBkg.scaleX = stage.canvas.width/1280;
    popupBkg.scaleY = stage.canvas.height/720;
    var h = new createjs.Shape();
    h.graphics.beginFill('#000').drawRect(640/720*popupBkg.image.width,0,60/720*popupBkg.image.width,50/260*popupBkg.image.height);
    popupBkg.hitArea = h;
    popupCont.width = popupBkg.width;
    popupCont.height = popupBkg.height;   
    stage.setChildIndex(popupCont,stage.numChildren-1);
  }

  function popupShow(){
    this.resize();
    popupTxt.text = this.txt;
    popupBkg.addEventListener('click',function(e){
      pu.hide();
      });
    popupBkg.visible = true;
    popupTxt.visible = true;
    popupCont.addChild(popupBkg);
    popupCont.addChild(popupTxt);
    stage.addChild(popupCont);
    stage.setChildIndex(popupCont,stage.numChildren-1);
    stage.update();
  }

  function drawPlant(){
    plant.regX = 175 / 2; //width of each plant frame is 175
    plant.regY = 519 / 2; //height of each plant frame is 519
    targetWidth = 100 / 1120 * stage.canvas.width;
    scale = targetWidth / 175;
    plant.scaleX = scale;
    plant.scaleY = scale;
    plant.x = stage.canvas.width / 2;
    plant.y = 500/640*stage.canvas.height;
    stage.addChild(plant);
    stage.setChildIndex(plant,stage.numChildren-1);
  } 


  function drawWaterbar(){
    waterbarCont.x = 900 / 1120 * stage.canvas.width;
    waterbarCont.y = 200 / 640 * stage.canvas.height;
    var targetHeight = 250 / 640 * stage.canvas.height;
    waterbar.graphics.clear();

    waterbar.graphics.beginStroke('black').drawRect(0,0,stage.canvas.width/50,targetHeight).beginStroke().beginFill('white').drawRect(0,0,stage.canvas.width/50,targetHeight*(1-waterLevel)).beginFill('blue').drawRect(0,targetHeight*(1-waterLevel),stage.canvas.width/50,targetHeight*waterLevel);
    waterbarCont.addChild(waterbar);
    stage.setChildIndex(waterbarCont,stage.numChildren-1);
  }


  function init(){
    console.clear();
    stage = new createjs.Stage("mainCanvas");
    stage.enableMouseOver();
    popupCont = new createjs.Container();
    stage.addChild(popupCont);
    waterbarCont = new createjs.Container();
    waterbarCont.addChild(waterbar);
    stage.addChild(waterbarCont);
    waterBarText = new createjs.Text('ΝΕΡΟ','20px Arial', 'black');
    stage.addChild(waterBarText);
    statusText = new createjs.Text("Φόρτωση...", "20px Arial", "white");
  	statusText.textAlign = "center";
  	statusText.textBaseline = "middle";
  	stage.addChild(statusText);
  	resize();
    // Resource preloading
    for (var i = 0; i < resourceNames.length; i++) {

      resources[i] = new Image();
      resources[i].src = "resource/" + resourceNames[i];
      resources[i].onload = queueFileLoad;

    }
    // The last queueFileLoad calls queueComplete. Execution continues there.

  }

function imgByName(name) {
  return resources[resourceNames.indexOf(name)];
}

function queueFileLoad(event) {
  resourcesLoaded++;
  statusText.text = "Φόρτωση " + parseInt(100*resourcesLoaded/resourceNames.length) + " %";  
  stage.update();
  if (resourcesLoaded == resourceNames.length)  	
    queueComplete(event);
}

function queueComplete(event) {
  console.log("Finished loading resources");
  statusText.visible = false;
  bg = new createjs.Bitmap(imgByName("background.svg"));
  stage.addChild(bg);
  var onMenuClick = [onMenuHome, onMenuHelp, onMenuAbout, onMenuPrevious, onMenuNext];
  for (i = 0; i < 3; i++) {
    menubar[i] = new createjs.Bitmap(resources[resourceNames.indexOf('bar_home.svg') + i]);
    menubar[i].addEventListener("click", onMenuClick[i]);
    menubar[i].addEventListener("mouseover", function(event) {
      // Bring the target on top in its container, mostly for the rotation animation
      event.target.parent.setChildIndex(event.target, event.target.parent.numChildren - 1);
      event.target.scaleX = 1.2*event.target.savedscaleX;
      event.target.scaleY = 1.2*event.target.savedscaleY;
      stage.update();
      });
    menubar[i].addEventListener("mouseout", function(event) {
      event.target.scaleX = event.target.savedscaleX;
      event.target.scaleY = event.target.savedscaleY;
      stage.update();
      });
    stage.addChild(menubar[i]);
  }
  water = new createjs.Bitmap(imgByName('water.png'));
  stage.addChild(water);


  theWindow = new createjs.Bitmap(imgByName('closewindow.svg'));
  isWindowOpen = false;

  var h = new createjs.Shape();
  h.graphics.beginFill('black').drawRect(0,0,theWindow.image.width,theWindow.image.height);
  theWindow.hitArea = h;
  theWindow.addEventListener('click',function(event){
    if (isPlaying){
      if (isWindowOpen){
        theWindow.image = imgByName('closewindow.svg');
        isWindowOpen = false;
      }
      else{
        theWindow.image = imgByName('openwindow.svg');
        isWindowOpen = true;
      }
      stage.update();
    }
  });
  stage.addChild(theWindow);
  potistiri = new createjs.Bitmap(imgByName('potistiri.svg'));
  isWatering = false;
  water.visible = false;
  potistiri.addEventListener('mousedown',function(event){
    if (isPlaying){
      potistiri.rotation = 45;
      isWatering = true;
      water.visible = true;
      stage.setChildIndex(water,stage.numChildren-1);//bring it front
    }
  });
  potistiri.addEventListener('click',function(event){//used as mouseup
    potistiri.rotation = 0;
    isWatering = false;
    water.visible = false;
  })
  potistiri.addEventListener('pressup',function(event){
    potistiri.rotation = 0;
    isWatering = false;
    water.visible = false;
  });
  stage.addChild(potistiri);




  playButton = new createjs.Bitmap(imgByName('playactive.svg'));
  playButton.addEventListener('click',function(event){
    if (!isPlaying){
      initSim();
    }
  });
  stage.addChild(playButton);
  
  plant = frameFromSheet(0);
  stage.addChild(plant);

  popupBkg = new createjs.Bitmap(imgByName('popup.svg'));
  popupBkg.visible = false; //it will be handled by popupShow and popupHide later
  popupTxt = new createjs.Text(this.txt,'20px Arial', 'white');
  popupCont.addChild(popupBkg);

  resize();
  window.addEventListener('resize', resize, false);
  createjs.Ticker.on('tick', tick);
  createjs.Ticker.framerate = 10;
}

function initSim(newLevel) {
      playButton.image = imgByName('playinactive.svg');
      isPlaying = true;
      frame = 0;
      plant.visible = false;
      plant = frameFromSheet(frame);
      plant.visible = true;
      drawPlant();
      timeWithoutWater = 0;
      timeWithSun = 0;
      time = 0;
      waterLevel = 1;
      popupHide();

}

function resize() {
  // Resize the canvas element
  winratio = window.innerWidth/window.innerHeight;
  if (winratio >= ratio) {
    stage.canvas.height = window.innerHeight;
    stage.canvas.width = stage.canvas.height * ratio;
  } else {
    stage.canvas.width = window.innerWidth;
    stage.canvas.height = stage.canvas.width / ratio;
  }

  if (!menubar[2]) {
    statusText.x = stage.canvas.width / 2;
    statusText.y = stage.canvas.height / 2;
    statusText.font = parseInt(stage.canvas.height/10) + "px Arial";
    return;
  }
  var bbs = stage.canvas.height / 10;  // bar button size
  var bbm = bbs / 5;  // bar button margin
  // TODO: local/global variables, eslint...
  for (i = 0; i < 3; i++) {
    // Leave one space for the level
    j = i;
    menubar[i].scaleX = bbs / menubar[i].image.width;
    menubar[i].scaleY = bbs / menubar[i].image.height;
    menubar[i].regX = menubar[i].image.width / 2;
    menubar[i].regY = menubar[i].image.height / 2;
    menubar[i].x = (j + 1)*bbm + bbs/2 + j*bbs;
    menubar[i].y = stage.canvas.height - bbm - bbs/2;
    // These copies are used to preserve the original scale on mouseover
    menubar[i].savedscaleX = menubar[i].scaleX;
    menubar[i].savedscaleY = menubar[i].scaleY;
  }

  var targetWidth = 520 / 1120  * stage.canvas.width;
  var scale = targetWidth / theWindow.image.width;
  theWindow.scaleX = scale;
  theWindow.scaleY = scale;
  theWindow.regX = theWindow.image.width / 2;
  theWindow.regY = theWindow.image.height / 2;
  theWindow.x = stage.canvas.width / 2;
  theWindow.y = stage.canvas.height / 2;


  targetWidth = 200 / 1220 * stage.canvas.width;
  scale = targetWidth / potistiri.image.width;
  potistiri.scaleX = scale;
  potistiri.scaleY = scale;
  potistiri.regX = potistiri.image.width / 2;
  potistiri.regY = potistiri.image.height / 2;
  potistiri.x = 330 / 1120 * stage.canvas.width;
  potistiri.y = 450 / 640 * stage.canvas.height;

  targetWidth = 60 / 1120 * stage.canvas.width;
  scale = targetWidth / water.image.width;
  water.scaleX = scale;
  water.scaleY = scale;
  water.x = potistiri.x +100 / 1120 * stage.canvas.width;
  water.y = potistiri.y;

  targetWidth = 150 / 1220 * stage.canvas.width;
  scale = targetWidth / playButton.image.width;
  playButton.scaleX = scale;
  playButton.scaleY = scale;
  playButton.regX = playButton.image.width / 2;
  playButton.regY = playButton.image.height / 2;
  playButton.x = stage.canvas.width / 2;
  playButton.y = stage.canvas.height - bbm - bbs/2;


  // Fill all the canvas with the background
  bg.scaleX = stage.canvas.width / bg.image.width;
  bg.scaleY = stage.canvas.height / bg.image.height;

  waterBarText.font = parseInt(stage.canvas.height/30) + "px Arial";
  waterBarText.x = 1000/1280*stage.canvas.width;
  waterBarText.y = 180/720*stage.canvas.height;
  stage.addChild(waterBarText);

  //resize popup if it exists
  if (pu){
    pu.resize();
  }


  // Bring statusText in front of everything
  statusText.textAlign = "right";
  statusText.textBaseline = "alphabetic";
  stage.setChildIndex(statusText, stage.numChildren - 1);

  
  drawWaterbar();
  drawPlant();
  stage.update();
}


function onMenuHelp(event) {
  alert("Επιλέξτε εικόνες από το κάτω κουτί και βάλτε τις στο δεξί κουτί έτσι ώστε να ταιριάζουν με το αριστερό κουτί.");
}

function onMenuHome(event) {
  window.history.back();
}

function onMenuPrevious(event) {
  initLevel((level+4) % 5);
}

function onMenuNext(event) {
  initLevel((level+1) % 5);
}

function onMenuAbout(event) {
  window.open("credits/index_DS_II.html");
}

function tick(){
  if (isPlaying){
    time += 1;
    if (isWindowOpen){
      timeWithSun += 1;
    }


    if (time % 78 == 0){
      if (timeWithSun/time < sunThreshold){
        pu = new popup();
        popupSetTxt("Το φυτό δεν είχε πολύ φως! \n Άνοιξες το παράθυρο;");
        popupShow();
        isPlaying = false;
        playButton.image = imgByName('playactive.svg');
        return;
      }
      if (frame < 7){
        frame += 1;
        plant.visible = false;
        plant = frameFromSheet(frame);
        plant.visible = true;
      }
      else{
        pu = new popup();
        popupSetTxt("Μπράβο! Τα κατάφερες!");
        popupShow();
        isPlaying = false;
        playButton.image = imgByName('playactive.svg');        
      }
    }
    if (isWatering){
      timeWithoutWater = 0;
      if (waterLevel < 1){
        waterLevel += 0.01;
      }
    }
    else{//if it's not watering
      if (waterLevel > 0){
        waterLevel -= 0.01
      }
      else{
        timeWithoutWater += 1;
        if (timeWithoutWater > waterThreshold){
          pu = new popup();
          popupSetTxt("Το φυτό δεν ποτίστηκε αρκετά.");
          popupShow();
          isPlaying = false;
          playButton.image = imgByName('playactive.svg');
        }
      }
    }
    drawPlant();
    drawWaterbar();
    stage.update();
  }
}

//helper functions
function frameFromSheet(frameNum){
  //takes the image name and gives the requested frame starting from frame 0
  
  var croppedImage = new createjs.Bitmap(imgByName('plant.png'));
  croppedImage.sourceRect = new createjs.Rectangle(frameNum*175,0,175,519);
  return(croppedImage);
}
</script>
</body>
</html>